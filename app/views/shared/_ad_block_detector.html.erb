<script>
  $(function () {
    var token = 'poinpgwawoiwoignsdoa';
    var isPremium = <%= user_signed_in? && current_user.has_valid_subscription? %>;
    var hasShareTweet = <%= user_signed_in? && current_user.sharing_count(5.minutes) > 0 %>;
    var message = '<%= t('before_sign_in.ad_blocker_detected_with_count', seconds: 3) %>';
    var redirectPath = "<%= root_path(via: current_via('ad_blocker_detected')).html_safe %>";

    if (isPremium || hasShareTweet) {
      return;
    }

    new AdBlockDetector(token).detect(function () {
      ToastMessage.warn(message);
      ToastMessage.freeze();

      setTimeout(function () {
        window.location.href = redirectPath;
      }, 3000);

      var label = {
        userId: '<%= current_user&.id %>',
        deviceType: '<%= request.device_type %>'
      };

      ga('send', {
        hitType: 'event',
        eventCategory: 'AdBlocker detected',
        eventAction: 'detected',
        eventLabel: JSON.stringify(label)
      });
    });
  });
</script>
