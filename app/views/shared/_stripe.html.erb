<script src='https://js.stripe.com/v3'></script>

<% if user_signed_in? && current_user.has_valid_subscription? %>
  <script>
    $(function () {
      function disableButton(button) {
        if (!button.data('btn-disabled')) {
          button.data('btn-disabled', true);
          button.attr('disabled', 'disabled');
          button.addClass('disabled');
          button.text('<%= t('.already_purchased') %>');
        }
        return false;
      }

      var selector = '.btn-checkout, .btn-one-time-checkout';

      $(selector).each(function () {
        disableButton($(this));
      })
      $(document).on('click', selector, function () {
        return disableButton($(this));
      });

      $(document).on('click', '.btn-end-trial', function () {
        if (window.endTrialModal) {
          window.endTrialModal.show(this);
          return false;
        }
      });
    });
  </script>
<% elsif user_signed_in? %>
  <script>
    $(function () {
      var stripe = Stripe("<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>");

      function trackClickEvent($btn) {
        var props = {
          page: window.location.href,
          id: $btn.attr('id'),
          class: $btn.attr('class'),
          text: $btn.text().trim()
        };
        ahoy.track('CheckoutButton clicked', props);
      }

      function redirectToCheckout() {
        var url = '<%= raw api_v1_checkout_sessions_path(via: current_via) %>';
        $.post(url).done(function (res) {
          stripe.redirectToCheckout({sessionId: res.session_id}).then(function (result) {
            logger.log(result.error.message);
          });
        }).fail(showErrorMessage);
      }

      $(document).on('click', '.btn-checkout', function () {
        trackClickEvent($(this));
        redirectToCheckout();
        return false;
      });

      function redirectToOneTimeCheckout(itemId) {
        var url = '<%= raw api_v1_checkout_sessions_path(via: current_via) %>';
        url += '&item_id=' + itemId;

        $.post(url).done(function (res) {
          stripe.redirectToCheckout({sessionId: res.session_id}).then(function (result) {
            logger.log(result.error.message);
          });
        }).fail(showErrorMessage);
      }

      $(document).on('click', '.btn-one-time-checkout', function () {
        var $btn = $(this);
        trackClickEvent($btn);
        redirectToOneTimeCheckout($btn.data('item-id'));
        return false;
      });
    });
  </script>
<% else %>
  <%# TODO Redirect to pricing page %>
<% end %>
