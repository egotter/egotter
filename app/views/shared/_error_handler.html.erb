<script>
  (function () {
    var userId = '<%= current_user&.id %>';
    var visitId = '<%= current_visit&.id %>';
    var eventAction = '<%= "#{controller_name}##{action_name}" %>';
    var deviceType = '<%= request.device_type %>';
    var os = '<%= request.os + ' ' + request.os_version %>';
    var browser = '<%= request.browser + ' ' + request.browser_version %>';

    var sendError = function (kind, message) {
      var eventLabel = JSON.stringify({
        userId: userId,
        visitId: visitId,
        deviceType: deviceType,
        os: os,
        browser: browser,
        cookie: navigator.cookieEnabled,
        message: message,
        path: window.location.href,
        referer: document.referrer
      });

      var eventParams = {
        hitType: 'event',
        eventCategory: 'JS Exception (' + kind + ')',
        eventAction: eventAction,
        eventLabel: eventLabel
      };

      try {
        if (ga) {
          ga('send', eventParams);
          console.warn('Sent JS Exception to GA', kind, message);
        } else {
          console.warn('ga() is not defined', kind, message);
        }
      } catch (e) {
        console.error('Sending JS Exception to GA is failed', e);
      }
    };

    window.onerror = function (message, filePath, rowNumber, columnNumber) {
      sendError('onerror', 'message=' + message + '&filePath=' + filePath + '&rowNumber=' + rowNumber + '&columnNumber=' + columnNumber);
    };

    window.addEventListener('unhandledrejection', function (e) {
      sendError('unhandledrejection', e.message);
    });
  })();
</script>
