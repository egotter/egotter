<div class="menu-items media <%= menu_name %>" style="display: none;">
  <%= link_to search_path_for(menu_name, twitter_user.screen_name), class: 'result-link' do %>
    <h3 class="h4"><%= title_for(menu_name, twitter_user.screen_name) %></h3>
    <div class="text-center description"><%= description_for(menu_name, twitter_user.screen_name).html_safe %></div>

    <div class="media-body">
      <%= link_to search_path(screen_name: 'SCREEN_NAME'), class: 'user-template', style: 'display: none;' do %>
        <%= normal_icon_img(Hashie::Mash.new({screen_name: '#', profile_image_url_https: image_path('gray_48x48.png')}), class: 'img-rounded') %>
      <% end %>
      <div class="text-muted progress-msg" style="display: none;"></div>
    </div>

    <div class="media-right" style="display: none;">
      <div class="common-chart"></div>
    </div>

    <div>
      <%= link_to(t('timelines.show.reload_this_page'), timeline_path(screen_name: twitter_user.screen_name), class: 'btn btn-info btn-block reload-btn', style: 'display: none') %>
      <%= link_to(t('timelines.show.view_more_with_num_html', num: 'NUM'), search_path_for(menu_name, twitter_user.screen_name), class: 'btn btn-info btn-block btn-view-more', style: 'display: none') %>
    </div>
  <% end %>
</div>

<script>
  $(function () {
    var menuName = '<%= menu_name %>';
    var apiEndpoint = '<%= api_v1_summary_path_for(menu_name) %>';
    var uid = '<%= twitter_user.uid %>';
    var $summaryBox = $('.menu-items.<%= menu_name %>');
    var $progressMsgBox = $summaryBox.find('.progress-msg');
    var progressMessages = {
      empty: "<%= t('timelines.show.empty_result_with_details_html') %>",
      under_calculation: "<%= t('timelines.show.under_calculation_with_details_html') %>"
    };
    var $resultLinkButtons = {
      reload: $summaryBox.find('.reload-btn'),
      more: $summaryBox.find('.btn-view-more')
    };

    $.getJSON(apiEndpoint, {uid: uid}, function(data) {
      console.log(data);

      if (!data || !data.users || data.users.length <= 0) {
        $summaryBox.find('.result-link').attr('href', '#').attr('onclick', 'return false;');
        $progressMsgBox.html(progressMessages.empty).show();
        $resultLinkButtons.reload.show();
        $("div[data-replaced-by='" + menuName + "']").remove();
        $(".menu-items." + menuName).show();
        return;
      }

      var $userTemplate = $summaryBox.find('.user-template');
      $.each(data.users, function () {
        var user = this;
        var $cloned = $userTemplate.clone();
        $cloned
          .attr('href', $cloned.attr('href').replace('SCREEN_NAME', user.screen_name))
          .removeClass('user-template')
          .find('img')
          .attr({src: user.profile_image_url_https, alt: user.screen_name})
          .end()
          .css('display', 'inline-block')
          .insertAfter($userTemplate);
      });
      $resultLinkButtons.more.find('span').text(data.count).end().show();

      var graphOption = $.extend(true, {}, window.common_pie_chart_options);
      graphOption.series[0].data = [
        {name: '<%= t("charts.#{menu_name}") %>', y: 100.0 / 3.0},
        {name: '<%= t('charts.others') %>',  y: 200.0 / 3.0}
      ];

      $("div[data-replaced-by='" + menuName + "']").remove();
      $(".menu-items." + menuName).show();

      $summaryBox.find('.media-right').show().end().find('.common-chart').highcharts(graphOption);
    });
  });
</script>